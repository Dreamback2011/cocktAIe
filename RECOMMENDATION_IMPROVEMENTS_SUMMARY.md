# 推荐算法改进总结

## 已实施的改进

### 1. 降低需求匹配权重 ✅
- **修改前**: `need_weight=2.5`，需求匹配占60%
- **修改后**: `need_weight=1.5`，需求匹配占40%，维度匹配占60%
- **效果**: 减少通用需求（如"comfort", "nostalgia"）对推荐结果的过度影响

### 2. 反通用性惩罚机制 ✅
- **实现**: 识别包含通用需求的鸡尾酒并降分
- **通用需求列表**: `["comfort", "relaxation", "casual fun", "ease", "approachability", "nostalgia"]`
- **惩罚规则**:
  - 包含2个以上通用需求: 降25%（系数0.75）
  - 包含1个通用需求: 降10%（系数0.9）
- **效果**: Cuba Libre等包含多个通用需求的鸡尾酒将被降分

### 3. 推荐历史记录与降权 ✅
- **实现位置**: `backend/app/agents/cocktail_agent.py`
- **功能**:
  - 使用`task_id`作为`session_id`，记录每个session的推荐历史
  - 保留最近20次推荐记录
  - 对已推荐的鸡尾酒应用降分惩罚：
    - 首次推荐后再次推荐: 降30%（系数0.7）
    - 每增加一次使用: 额外降10%
    - 最多降50%（系数0.5）

### 4. Top-K随机化机制 ✅
- **实现位置**: `backend/app/utils/cocktail_db.py`的`find_best_match`方法
- **机制**:
  - 从Top-10到Top-30候选中进行加权随机选择
  - 使用"基础概率 + 分数加成"的加权策略
  - 分数越高概率越大，但Top-K候选都有机会被选中
  - 确保连续生成的结果具有随机性

### 5. 多样性奖励提升 ✅
- **修改前**: `diversity_bonus=0.35`
- **修改后**: `diversity_bonus=0.4`
- **效果**: 提高未使用鸡尾酒的推荐概率

## 核心改进原理

### 问题诊断
1. **Cuba Libre总是被推荐的原因**:
   - 包含3个通用需求（nostalgia, comfort, casual fun）
   - 维度组合（4,2,3）相对中庸，容易匹配多种输入
   - 需求匹配权重过高（2.5），导致通用需求匹配的鸡尾酒总是胜出

### 解决方案
1. **降低需求权重**: 从2.5降到1.5，维度匹配权重从40%提升到60%
2. **反通用性惩罚**: 对包含通用需求的鸡尾酒直接降分
3. **历史降权**: 对已推荐的鸡尾酒应用惩罚，避免重复推荐
4. **Top-K随机化**: 即使只能匹配到一个小范围，也要保证随机性

## 预期效果

- **多样性提升**: 推荐结果覆盖60%以上的鸡尾酒类型
- **避免重复**: 相同或相似输入不再总是推荐相同鸡尾酒
- **随机性保证**: 即使匹配到相同区间，连续生成也会有不同的结果
- **平衡匹配度与多样性**: 既保证匹配度，又确保推荐结果的多样性

## 技术细节

### 评分公式（改进后）
```
base_score = (维度匹配 × 0.6 + 需求匹配 × 0.4) × 通用性惩罚系数
diversity_score = 多样性奖励（未使用）或 多样性惩罚（已使用）
final_score = base_score × 历史惩罚系数 + category_bonus
```

### 随机化算法
- 从Top-10到Top-30候选中选择
- 概率计算: `base_prob + score_bonus * sqrt(normalized_score)`
- 加权随机选择，确保Top-K都有机会

## 测试建议

1. **同一输入多次测试**: 验证连续生成的结果是否不同
2. **相似输入测试**: 验证相似情感输入是否推荐不同鸡尾酒
3. **多样性统计**: 测试10次不同输入，统计推荐鸡尾酒的覆盖范围
